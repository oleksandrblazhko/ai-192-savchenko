# Підсумок
Веб-файли cookie (тут мають назву файли cookie) часто є основним вектором атаки для зловмисників (зазвичай націленої на інших користувачів), і програма завжди повинна прикладати всі зусилля, щоб захистити файли cookie.

HTTP є протоколом без стану, тобто він не містить жодних посилань на запити, які надсилає один й той самий користувач. Щоб вирішити цю проблему, були створені та додані сеанси до HTTP-запитів. Браузери, як обговорювалося в [тестуванні сховища браузера](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/11-Client-side_Testing/12-Testing_Browser_Storage), містять безліч механізмів зберігання. У цьому розділі посібника кожний докладно обговорюється.

Найбільш використовуваним механізмом зберігання сеансів у браузерах є зберігання файлів cookie. Файли cookie можуть бути встановлені сервером, включивши заголовок [Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie) у відповідь HTTP або за допомогою JavaScript. Файли cookie можна використовувати в багатьох ситуаціях, наприклад:

- керування сеансами
- персоналізація
- відстеження

Щоб захистити дані файлів cookie, галузь розробила засоби, які допомагають заблокувати ці файли та обмежити їхню схильність до атак. З часом файли cookie стали кращим механізмом зберігання веб-додатків, оскільки вони забезпечують велику гнучкість для використання та захисту.

Засоби захисту файлів cookie:

- [Атрибути файлів cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#creating_cookies)
- [Префікси файлів cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#cookie_prefixes)

# Цілі тестування

- Переконатися, що для файлів cookie встановлено правильну конфігурацію безпеки.

# Як протестувати

Нижче буде розглянуто опис кожного атрибута та префікса. Тестувальник повинен перевірити, чи правильно вони використовуються програмою. Файли cookie можна переглянути за допомогою [проксі-сервера-перехоплювача](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#intercepting-proxy) або переглянувши файл cookie у браузері.

## Атрибути файлів cookie
### Атрибут Secure
Атрибут [**Secure**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#secure) повідомляє веб-переглядачу надсилати файли cookie, лише якщо запит надсилається через безпечний канал, наприклад **HTTPS**. Це допоможе захистити файли cookie від передачі в незашифрованих запитах. Якщо до програми можна отримати доступ як через **HTTP**, так і через **HTTPS**, зловмисник зможе перенаправити користувача для надсилання файлів cookie як частину незахищених запитів.

### Атрибут HttpOnly
Атрибут [**HttpOnly**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#httponly) використовується для запобігання таким атакам, як витік сеансу, оскільки він не дозволяє отримати доступ до файлу cookie через клієнтський сценарій, наприклад JavaScript.

*Це не обмежує всі XSS-атаки, оскільки зловмисник може надіслати запит замість користувача, але значно обмежує охоплення векторів атаки XSS.*

### Атрибут Domain
Атрибут [**Domain**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Scope_of_cookies) використовується для порівняння домену cookie з доменом сервера, для якого виконується запит HTTP. Якщо домен збігається або якщо це субдомен, далі буде перевірено атрибут [path](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#path-attribute).

Зауважте, що лише хости, які належать до вказаного домену, можуть установлювати файли cookie для цього домену. Крім того, атрибут **domain** не може бути доменом верхнього рівня (наприклад, **.gov** або **.com**), щоб сервери не могли встановлювати довільні файли cookie для іншого домену (наприклад, встановлення файлу cookie для **owasp.org**). Якщо атрибут domain не встановлено, тоді ім’я хоста сервера, який створив файл cookie, використовується як значення **domain** за замовчуванням.

Наприклад, якщо файл cookie встановлено програмою на **app.mydomain.com** без встановленого атрибута домену, тоді файл cookie буде повторно надіслано для всіх наступних запитів для **app.mydomain.com** та його субдоменів (таких, як **hacker.app.mydomain.com**), але не на **otherapp.mydomain.com**. Якби розробник хотів послабити це обмеження, він міг би встановити атрибут **domain** на **mydomain.com**. У цьому випадку файл cookie надсилатиметься на всі запити для субдоменів **app.mydomain.com** і **mydomain.com**, наприклад **hacker.app.mydomain.com** і навіть **bank.mydomain.com**. Якщо в піддомені був уразливий сервер (наприклад, **otherapp.mydomain.com**), а атрибут **domain** було встановлено занадто вільно (наприклад, **mydomain.com**), то вразливий сервер може використовуватися для збору файлів cookie (наприклад, токени сесії) у всьому діапазоні **mydomain.com**.

### Атрибут Path
Атрибут [**Path**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Scope_of_cookies) відіграє важливу роль у встановленні області видимості файлів cookie в поєднанні з [domain](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#domain-attribute). Окрім домену, можна вказати URL-шлях, для якого дійсний файл cookie. Якщо домен і шлях збігаються, файл cookie буде надіслано в запиті. Подібно до атрибута домену, якщо атрибут шляху встановлено занадто вільно, це може зробити програму вразливою для атак з боку інших програм на тому самому сервері. Наприклад, якщо для атрибута шляху було встановлено корінь веб-сервера **/**, то файли cookie програми надсилатимуться до кожної програми в межах одного домену (якщо на одному сервері розміщено кілька програм). Кілька прикладів для кількох програм на одному сервері:

- **path=/bank**
- **path=/private**
- **path=/docs**
- **path=/docs/admin**

### Атрибут Expires
Атрибут [**Expires**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Permanent_cookies) використовується для:

- Встановлення постійних файлів cookie
- Обмеження тривалості життя, якщо сесія триває надто довго
- Видалення файлу cookie примусово, встановивши для нього минулу дату

На відміну від [сеансових файлів cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Session_cookies), постійні файли cookie використовуватимуться браузером, доки не закінчиться термін їх дії. Коли термін дії перевищить встановлений час, браузер видалить файл cookie.

### Атрибут SameSite
Атрибут [**SameSite**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_cookies) використовується для підтвердження того, що файли cookie не слід надсилати разом із міжсайтовими запитами. Ця функція дозволяє серверу зменшити ризик витоку міжсистемної інформації. У деяких випадках він також використовується як стратегія зменшення ризику (або механізм глибокого захисту) для запобігання атакам [підробки міжсайтових запитів](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery). Цей атрибут можна налаштувати в трьох різних режимах:

- **Strict**
- **Lax**
- **None**

#### Значення Strict
Значення **Strict** — це найбільш обмежене використання **SameSite**, яке дозволяє браузеру надсилати файли cookie лише в основний контекст без навігації верхнього рівня. Іншими словами, дані, пов’язані з файлами cookie, надсилатимуться лише за запитами, що відповідають поточному сайту, який відображається в рядку URL-адреси браузера. Файли cookie не надсилатимуться за запитами, створеними сторонніми веб-сайтами. Це значення особливо рекомендовано для дій, які виконуються в одному домені. Однак це може мати деякі обмеження, оскільки деякі системи керування сеансами негативно впливають на навігацію користувача. Оскільки веб-браузер не буде надсилати файли cookie на будь-які запити, згенеровані стороннім доменом або електронною поштою, користувачеві потрібно буде повторно ввійти, навіть якщо він уже має автентифікований сеанс.

#### Значення Lax
Значення **Lax** є менш обмежувальним, ніж **Strict**. Файл cookie буде надіслано, якщо URL-адреса збігається з доменом файлу cookie, навіть якщо посилання надходить з іншого домену. Більшість браузерів вважають це значення поведінкою за замовчуванням, оскільки воно забезпечує кращу взаємодію з користувачем, ніж значення **Strict**. Він не активується для активів, таких як зображення, для доступу до яких можуть не знадобитися файли cookie.

#### Значення None
Значення **None** вказує, що браузер надсилатиме файл cookie на міжсайтові запити (звичайна поведінка до впровадження **SameSite**), лише якщо також використовується атрибут **Secure**, наприклад, **SameSite=None; Secure**. Це рекомендоване значення замість того, щоб не вказувати значення **SameSite**, оскільки воно примусово використовує [атрибут **secure**](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#secure-attribute).

## Префікси файлів cookie
За задумом файли cookie не мають можливостей гарантувати цілісність і конфіденційність інформації, що зберігається в них. Ці обмеження не дозволяють серверу бути впевненим у тому, як атрибути певного файлу cookie були встановлені під час створення. Щоб надати серверам такі функції за допомогою зворотної сумісності, галузь запровадила концепцію [**префіксів імен файлів cookie**](https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-cookie-prefixes-00), щоб полегшити передачу таких деталей, вбудованих як частину назви файлів cookie.

### Префікс Host
Префікс [**__Host-**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#cookie_prefixes)передбачає, що файли cookie відповідатимуть таким умовам:

1. Файл cookie має бути встановлено з [атрибутом **Secure**](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#secure-attribute).
2. Файл cookie має бути встановлено з URI, котрий агент користувача вважає безпечним.
3. Надсилається лише хосту, який встановив файл cookie, і повинен НЕ МІСТИТИ [атрибут **Domain**](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes).
4. Для файлу cookie має бути встановлено [атрибут **Path**](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes#path-attribute) зі значенням **/**, щоб він надсилався на кожен запит до хосту.

З цієї причини файл cookie **Set-Cookie: __Host-SID=12345; Secure; Path=/** буде прийнято, тоді як будь-який із наступних завжди буде відхилено: **Set-Cookie: __Host-SID=12345** **Set-Cookie: __Host-SID=12345; Secure** **Set-Cookie: __Host-SID=12345; Domain=site.example** **Set-Cookie: __Host-SID=12345; Domain=site.example; Path=/** **Set-Cookie: __Host-SID=12345; Secure; Domain=site.example; Path=/**

### Префікс Secure
Префікс [__Secure-](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#cookie_prefixes) є менш обмежувальним і може бути введений шляхом додавання чутливості до регістру рядка **__Secure-** до імені файлу cookie. Будь-який файл cookie, який відповідає префіксу **__Secure-**, повинен відповідати таким умовам:

1. Файл cookie має бути встановлено з атрибутом Secure.
2. Файл cookie має бути встановлено з URI, який агент користувача вважає безпечним.

## Найкращі методи
Виходячи з потреб програми та того, як має функціонувати файл cookie, потрібно застосовувати атрибути та префікси. Чим більш закритий файл cookie, тим краще.

Зібравши все це разом, ми можемо визначити найбільш безпечну конфігурацію атрибута cookie як: **Set-Cookie: __Host-SID=<session token>; path=/; Secure; HttpOnly; SameSite=Strict**.